"use strict";angular.module("adminApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.tinymce"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/News",{templateUrl:"views/news.html",controller:"NewsCtrl"}).when("/Pages",{templateUrl:"views/pages.html",controller:"PagesCtrl"}).when("/Blog",{templateUrl:"views/blog.html",controller:"BlogCtrl"}).when("/Pub",{templateUrl:"views/pub.html",controller:"PubCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!1).hashPrefix("!")}]),angular.module("adminApp").controller("MainCtrl",["$scope","$location","User",function(a,b,c){var d=function(){return!1};d()&&alert("Imagine being redirected to the News page"),a.login=function(){var a=document.getElementById("login-email").value,d=document.getElementById("login-password").value,e=c.login(a,d);e.success===!0?b.path("/News"):document.getElementById("login-errors").innerHTML=e.error},a.signup=function(){var a=document.getElementById("signup-email").value,b=document.getElementById("signup-password").value,d=document.getElementById("signup-confirm").value,e=document.getElementById("signup-name").value,f=document.getElementById("signup-signature").value,g=c.signup(a,b,d,e,f);g.success===!0?alert("Merci de votre enregistrement. Vous recevrez un email lorsque votre candidature sera validée."):document.getElementById("signup-errors").innerHTML=g.error}}]),angular.module("adminApp").factory("User",function(){return{login:function(a,b){var c="",d=!0;return-1===a.indexOf("@")&&(d=!1,c="Il ne s'agit pas d'un email valide."),""===b&&(d=!1,c="Le champ mot de passe est vide."),""===a&&(d=!1,c="Le champ email est vide."),{success:d,error:c}},signup:function(a,b,c,d,e){var f="",g=!0;return b!==c&&(g=!1,f="Le mot de passe ne correspond pas à la confirmation."),-1===a.indexOf("@")&&(g=!1,f="L'email n'est pas valide."),(""===a||""===b||""===c||""===d||""===e)&&(g=!1,f="Certains champs n'ont pas été remplis."),{success:g,error:f}}}}),angular.module("adminApp").controller("NewsCtrl",["$scope","News",function(a,b){var c=[],d=(new Date).getTime();b.getNews(function(b){c=b,a.news=c}),a.sendNews=function(){var d=parseInt(a.currentNews.id),e=a.currentNews.title,f=a.currentNews.content,g=a.currentNews.date,h=document.getElementById("newsMag").checked?1:0;return e||f||g?(b.save(function(b){c=b,a.news=c},e,f,g,d,h),void a.addNews()):(alert("Certains champs ne sont pas remplis."),!1)},a.delete=function(d){var e=confirm("Voulez vous vraiment supprimer la News n°"+d+" ?");d=parseInt(d),e&&b.delete(function(b){c=b,a.news=b},d)},a.addNews=function(){a.currentNews={date:d,content:"",mag:0},document.getElementById("newsMag").checked=!1,a.sendText="Créer News"},a.modify=function(c){b.getNews(function(b){a.currentNews=b,a.sendText="Modifier News"},c)},a.sendText="Créer News",a.currentNews={date:d,content:""},a.tinymceOptions={selector:"#newsContent",theme:"modern",plugins:["advlist autolink lists link image charmap print preview hr anchor pagebreak","searchreplace wordcount visualblocks visualchars code fullscreen","insertdatetime media nonbreaking table contextmenu directionality","emoticons template paste textcolor"],toolbar1:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons",image_advtab:!0}}]),angular.module("adminApp").factory("News",["$http","Server",function(a,b){var c,d=[],e=b.Url+"news/";return c=function(c,f){var g=e+(f?"?id="+f:"");a.get(g,{cache:"true"}).success(function(a){var e,f,g=b.processResponse(a);for(e=0;e<g.length;e++)f=d.some(function(a){return JSON.stringify(a)===JSON.stringify(g[e])}),f||d.push(g[e]);g=g.length>1?g:g[0],c(g)}).error(b.errorHandler)},{getNews:function(a,b){var e;b||angular.isNumber(b)?(e=d.filter(function(a){return a.id===b})[0],"undefined"==typeof e?c(a,b):a(e)):d.length>0?a(d):c(a)},"delete":function(c,f){var g,h=e+"delete/?id="+f;if(f&&angular.isNumber(f))for(g=0;g<d.length;g++)if(d[g].id===f)return d.splice(g,1),a.get(h).success(function(){c(d)}).error(b.errorHandler),!0;return!1},save:function(c,f,g,h,i,j){var k,l=e+"save/",i=(this.save,i||0),m={id:i,title:f,content:g,mag:j};a({method:"POST",url:l,data:jQuery.param(m),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(a){if(0===parseInt(a))return alert("Vous êtes déconnecter. Veuillez vous reconnecter pour sauver la News.");var e=b.processResponse(a)[0];if(i&&angular.isNumber(i)){for(k=0;k<d.length;k++)if(d[k].id===i){d[k]=e;break}}else d.push(e);c(d)}).error(b.errorHandler)}}}]),angular.module("adminApp").controller("PagesCtrl",["$scope","Pages",function(a,b){var c=[];b.getPage(function(b){c=b,a.currentTitle=c[0].name,a.activePage=c[0].id,a.tinyMceContent=c[0].content,a.pages=c}),a.modify=function(c){b.getPage(function(b){var c=b;a.currentTitle=c.name,a.activePage=c.id,a.tinyMceContent=c.content},c)},a.delete=function(){var d=a.activePage,e=confirm("Voulez-vous vraiment supprimer la news n°"+d+" ?");e&&b.delete(function(b){c=b,a.modify(c[0].id)},d)},a.save=function(){var d={id:a.activePage,name:a.currentTitle,content:a.tinyMceContent};b.save(function(d){b.getPage(function(b){c=b,a.pages=c,a.modify(d.id)})},d)},a.addPage=function(){a.modify(0)},a.tinymceOptions={selector:"textarea",theme:"modern",plugins:["advlist autolink lists link image charmap print preview hr anchor pagebreak","searchreplace wordcount visualblocks visualchars code fullscreen","insertdatetime media nonbreaking table contextmenu directionality","emoticons template paste textcolor"],toolbar1:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons",image_advtab:!0}}]),angular.module("adminApp").factory("Pages",["$http","Server",function(a,b){var c,d=[],e=b.Url+"pages/";return c=function(c){a.get(e,{cache:"true"}).success(function(a){var e,f,g=b.processResponse(a);for(e=0;e<g.length;e++)f=d.some(function(a){return JSON.stringify(a)===JSON.stringify(g[e])}),f||d.push(g[e]);c(d)}).error(b.errorHandler)},{getPage:function(a,b){var e;if(d.length<1)e=this.getPage,c(function(){e(a,b)});else if(b&&angular.isNumber(b)){var f=d.filter(function(a){return a.id===+b})[0];f=f?f:{},a(f)}else a(d)},"delete":function(c,f){var g=e+"delete/?id="+f;a.get(g).success(function(a){var b;if(0===parseInt(a))alert("La suppression de la page a échoué.");else{for(b=0;b<d.length;b++)if(d[b].id===f){d.splice(b,1);break}c(d)}}).error(b.errorHandler)},save:function(c,f){{var g,h=f.id||0,i=e+"save/";this.save}f.id=h,a({method:"POST",url:i,data:jQuery.param(f),headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(a){if(0===parseInt(a))return alert("Vous êtes déconnecter. Veuillez vous reconnecter pour sauver la page.");var e=b.processResponse(a)[0];if(h&&angular.isNumber(h)){for(g=0;g<d.length;g++)if(d[g].id===h){d[g]=e;break}}else d.push(e);c(e)}).error(b.errorHandler)}}}]),angular.module("adminApp").controller("BlogCtrl",["$scope","Bloggers","BlogPosts",function(a,b,c){var d=[];b.getBlogger(function(b){d=b,a.bloggers=d,a.activeBlogger=d[0].id,a.blogger=d[0],c.getPosts(function(b){a.blogPosts=b},a.activeBlogger),a.currentNews={date:parseInt((new Date).getTime()),blogId:a.activeBlogger}}),a.select=function(d){b.getBlogger(function(b){a.activeBlogger=d,a.blogger=b,c.getPosts(function(b){a.blogPosts=b,a.currentNews={date:parseInt((new Date).getTime()),blogId:a.activeBlogger}},a.activeBlogger)},d)},a.addBlog=function(){a.activeBlogger=0,a.blogger={}},a.deleteBlog=function(){var c=confirm("Êtes-vous sûr de vouloir supprimer le blog "+a.blogger.name+" ?"),e=a.blogger;c&&b.delete(function(b){d=b,a.bloggers=b,a.select(d[0].id)},e)},a.saveBlogger=function(){var e=a.activeBlogger,f=a.blogger;b.save(function(e){b.getBlogger(function(b){a.blogger=e,a.activeBlogger=e.id,d=b,a.bloggers=d,c.getPosts(function(b){a.blogPosts=b},a.activeBlogger)})},e,f)},a.removeSponsor=function(b){var c=a.blogger.sponsors.indexOf(b);a.blogger.sponsors.splice(c,1)},a.removeAd=function(b){var c=a.blogger.ad.indexOf(b);a.blogger.ad.splice(c,1)},a.changePortrait=function(b){a.$apply(function(){console.log("files:",b.files);b.files})},a.addSponsors=function(b){a.$apply(function(){console.log("files:",b.files);b.files})},a.addAd=function(b){a.$apply(function(){console.log("files:",b.files);b.files})},a.addNews=function(){a.currentNews={date:parseInt((new Date).getTime()),blogId:a.activeBlogger}},a.modifyNews=function(b){a.currentNews=b},a.saveNews=function(){var b=a.currentNews,d=b.blogId;b.date=b.date||parseInt((new Date).getTime()),c.save(function(b){c.getPosts(function(c){a.currentNews=b,a.blogPosts=c},d)},b)},a.deleteNews=function(b){var d=confirm("Voulez-vous vraiment effacer le post n°"+b+" ?"),e=a.activeBlogger;d&&c.delete(function(b){a.blogPosts=b},b,e)},a.tinymceOptionsBio={selector:"#bioContent",theme:"modern",toolbar1:"bold italic | alignleft aligncenter alignright alignjustify | bullist",image_advtab:!0},a.tinymceOptionsNews={selector:"#newsContent",theme:"modern",plugins:["advlist autolink lists link image charmap print preview hr anchor pagebreak","searchreplace wordcount visualblocks visualchars code fullscreen","insertdatetime media nonbreaking table contextmenu directionality","emoticons template paste textcolor"],toolbar1:"undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview media | forecolor backcolor emoticons",image_advtab:!0}}]),angular.module("adminApp").factory("Bloggers",["$http","Server",function(a,b){var c,d=[],e=b.Url+"blogs/bloggers/";return c=function(c,f){var g=e+(f?"?id="+f:"");a.get(g,{cache:"true"}).success(function(a){var e,f,g=b.processResponse(a);for(g=g.map(function(a){return a.ad=a.ad.split("|"),a.sponsors=a.sponsors.split("|"),a}),e=0;e<g.length;e++)f=d.some(function(a){return JSON.stringify(a)===JSON.stringify(g[e])}),f||d.push(g[e]);g=g.length>1?g:g[0],c(g)}).error(b.errorHandler)},{getBlogger:function(a,b){var e;if(d.length<1)e=this.getBlogger,c(function(){e(a,b)});else if(b&&angular.isNumber(b)){var f=d.filter(function(a){return a.id===parseInt(b)});f=f[0]?f[0]:{},a(f)}else a(d)},"delete":function(c,f){var g=f.id,h=e+"delete/?id="+g;a.get(h).success(function(a){if(0===parseInt(a))return alert("La suppression a échoué du coté serveur.");var b;for(b=0;b<d.length;b++)if(d[b].id===g){d.splice(b,1);break}c(d)}).error(b.errorHandler)},save:function(c,f,g){var h,i,j=e+"save/",f=(this.save,f||0);g.id=f,g.ad=g.ad?g.ad.join("|"):"",g.sponsors=g.sponsors?g.sponsors.join("|"):"",i=jQuery.param(g),a({method:"POST",url:j,data:i,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(a){if(0===parseInt(a))return alert("Vous êtes déconnecter. Veuillez vous reconnecter pour sauver la News.");var e=b.processResponse(a)[0];if(f&&angular.isNumber(f)){for(h=0;h<news.length;h++)if(d[h].id===f){d[h]=e;break}}else d.push(e);c(e)}).error(b.errorHandler)}}}]),angular.module("adminApp").factory("BlogPosts",["$http","Server",function(a,b){var c,d=[],e=b.Url+"blogs/posts/";return c=function(c,f,g){var h=e+"blog/?blogId="+f;h=g?h+"&id="+g:h,a.get(h,{cache:"true"}).success(function(a){var e,g,h=b.processResponse(a);for(d[f]||(d[f]=[]),e=0;e<h.length;e++)g=d[f].some(function(a){return JSON.stringify(a)===JSON.stringify(h[e])}),g||d[f].push(h[e]);h=h.length>1?h:h[0],c(h)}).error(b.errorHandler)},{"delete":function(c,f,g){var h=e+"delete/?id="+g;a.get(h).success(function(a){var b;if(0===parseInt(a))return alert("Suppression a échoué.");for(b=0;b<d[g].length;b++)if(d[g][b].id===g){d[g].splice(b,1);break}c(d[g])}).error(b.errorHandler)},save:function(c,f){var g,h,i=e+"save/",j=(this.save,f.id||0);f.id=j,h=jQuery.param(f),a({method:"POST",url:i,data:h,headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"}}).success(function(a){if(0===parseInt(a))return alert("Vous êtes déconnecter. Veuillez vous reconnecter pour sauver la News.");var e=b.processResponse(a)[0];if(j&&angular.isNumber(j)){for(g=0;g<d[f.blogId].length;g++)if(d[f.blogId][g].id===j){d[f.blogId][g]=e;break}}else d[f.blogId].push(e);c(e)}).error(b.errorHandler)},getPosts:function(a,b,e){var f;if(!d[b]||d[b].length<1)f=this.getPosts,c(function(){f(a,b,e)},b,e);else if(e&&angular.isNumber(e)){var g=d[b].filter(function(a){return a.id===parseInt(e)});g=g[0]?g[0]:{},a(g)}else a(d[b])}}}]),angular.module("adminApp").directive("tsImageUpload",function(){return{template:"<div></div>",restrict:"EACM",link:function(a,b){b.text("this is the tsImageUpload directive")}}}),angular.module("adminApp").controller("PubCtrl",["$scope","Pub",function(a,b){var c=function(){a.verticals=b.getCat("vertical"),a.horizontals=b.getCat("horizontal")};a.removeImage=function(a){b.remove(a),c()},c()}]),angular.module("adminApp").factory("Pub",function(){var a=[{id:0,img:"http://placehold.it/750x250",vertical:0,horizontal:1},{id:1,img:"http://placehold.it/750x250",vertical:0,horizontal:1},{id:2,img:"http://placehold.it/250x750",vertical:1,horizontal:0},{id:3,img:"http://placehold.it/250x750",vertical:1,horizontal:0},{id:4,img:"http://placehold.it/750x250",vertical:0,horizontal:1}];return{remove:function(b){var c=a.indexOf(b);return a.splice(c,1),a},getPub:function(b){return b||angular.isNumber(b)?a.filter(function(a){return a.id===b}):a},getCat:function(b){return a.filter(function(a){return 1===a[b]})}}}),angular.module("adminApp").service("Server",function(){this.Url="http://tooski.webfactional.com/api/",this.processResponse=function(a){return a.map(function(a){var b=a.fields;return b.id=a.pk,b.date=new Date(b.date).getTime(),b})},this.errorHandler=function(a,b){alert("There was a connection problem with the server. ("+b+")")}});